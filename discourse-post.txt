````markdown
# Struggling with sops-nix in a Hybrid (NixOS + Standalone) Home Manager Flake

Hello everyone,

I'm hoping to get some expert eyes on a persistent `sops-nix` issue in my hybrid flake setup. I've been trying to solve this for a while and have gone through several refactors, but the same error persists, which tells me I'm fundamentally misunderstanding something about how configurations are evaluated.

### The Goal
I have a `flake.nix` that uses `flake-parts` to manage two types of configurations:
1.  **`nixosConfigurations`**: For my NixOS machines, which use Home Manager as a module.
2.  **`homeConfigurations`**: A standalone Home Manager configuration that I can apply to any machine.

My goal is for **both** types of configurations to share the exact same secrets, managed by `sops-nix`.

### The Problem
The `nixosConfigurations` build seems to work correctly, but the standalone `homeConfigurations` build consistently fails with the following error:

```
error: attribute '"api_keys/anthropic"' missing
       at /.../nix/home/home.nix:533:27:
          532|       ZSH_AI_COMMANDS_OPENAI_API_KEY = config.sops.secrets."api_keys/openai".path;
          533|       ANTHROPIC_API_KEY = config.sops.secrets."api_keys/anthropic".path;
             |                           ^
          534|       BW_SESSION = config.sops.secrets.bitwarden.path;
```

This happens in my `home/home.nix` file where I try to access the secret:
```nix
# home/home.nix (snippet)
home.sessionVariables = {
  # ...
  ANTHROPIC_API_KEY = config.sops.secrets."api_keys/anthropic".path;
  # ...
};
```

This tells me that for the `homeConfigurations` build, the `config.sops.secrets` attribute set is not being populated.

### My Configuration Structure
To make the setup modular, I've refactored the logic into a `./lib` directory, inspired by other flakes in the community.

<details>
<summary><b><code>flake.nix</code></b></summary>

```nix
{
  inputs = {
    # ... (all my inputs are here, including sops-nix, home-manager, flake-parts)
  };

  outputs = inputs:
    inputs.flake-parts.lib.mkFlake { inherit inputs; } {
      imports = [
        inputs.treefmt-nix.flakeModule
      ];
      systems = [ "x86_64-linux" ];
      perSystem = { config, pkgs, system, ... }: {
        # ... (devShells, treefmt config, etc.)
      };

      flake =
        let
          lib = import ./lib { inherit inputs; };
          hosts = import ./lib/hosts.nix { inherit inputs; };
        in
        {
          nixosConfigurations = lib.mapAttrs'
            (name: config: lib.nameValuePair name (lib.buildNixosSystem (config // { host = name; })))
            hosts.nixos;

          homeConfigurations = lib.mapAttrs'
            (name: config: lib.nameValuePair name (lib.buildHomeConfiguration (config // { username = name; })))
            hosts.home;
        };
    };
}
```
</details>

<details>
<summary><b><code>lib/default.nix</code> (The Core Logic)</b></summary>

```nix
# lib/default.nix
{ inputs, ... }:
let
  lib = inputs.nixpkgs.lib;
in
lib // rec {
  # ... (helper functions like forAllSystems, mkPkgs, etc.)

  # Builder for NixOS systems
  buildNixosSystem = { system, host, username, modules ? [ ] }:
    let
      pkgs = pkgsBySystem.${system};
      helpers = lib-helpers system;
    in
    lib.nixosSystem {
      specialArgs = {
        # ... (pkgs, pkgs-unstable, etc.)
      };
      modules = modules ++ [
        # ... (core modules like musnix, hyprland, etc.)
        ../modules/sops.nix # Import sops config as a module
        ../hosts/${host}/config.nix
      ];
    };

  # Builder for standalone Home Manager configurations
  buildHomeConfiguration = { system, username, modules ? [ ] }:
    let
      pkgs = pkgsBySystem.${system};
      helpers = lib-helpers system;
    in
    inputs.home-manager.lib.homeManagerConfiguration {
      pkgs = import inputs.nixpkgs-unstable {
        # ...
      };
      extraSpecialArgs = {
        # ...
      };
      modules =
        [ ../modules/sops.nix ]
        ++ modules
        ++ [
          inputs.sops-nix.homeManagerModules.sops
          ../home/home.nix
        ];
    };
}
```
</details>

<details>
<summary><b><code>modules/sops.nix</code> (The Problem Child)</b></summary>

```nix
# modules/sops.nix
{ lib, ... }:
{
  sops = {
    defaultSopsFile = ../secrets/secrets.yaml;
    defaultSopsFormat = "yaml";
    age.keyFile = "/home/lf/nix/secrets/age-key.txt";

    # This block is for the NixOS module.
    secrets = {
      "github_pat" = { };
      "api_keys/openai" = { };
      "api_keys/anthropic" = { };
      # ... and all other secrets
    };
  };

  # This block is for the standalone Home Manager module.
  sops.secrets = {
    "github_pat" = { };
    "api_keys/openai" = { };
    "api_keys/anthropic" = { };
    # ... and all other secrets
  };
}
```
</details>

### What I've Tried (The Journey of Failures)

1.  **Initial Approach:** Had separate `sops` blocks in my NixOS and Home Manager configurations. This was messy and led to the same error in the standalone build.

2.  **Centralized `sopsConfig`:** I created a `sopsConfig` variable in `flake.nix`'s `let` block and passed it into both the `nixosSystem` and `homeManagerConfiguration` module lists. **Result:** Same error.

3.  **Module Import Order:** Suspecting an evaluation order issue, I made sure the `sopsConfig` was the very first module imported in the `homeManagerConfiguration` list. **Result:** Same error.

4.  **Inlining the Config:** I abandoned the `sopsConfig` variable and directly inlined the entire `sops = { ... };` block into the `modules` list of both builders in `lib/default.nix`. **Result:** Same error.

5.  **The Current Approach:** Based on documentation, I realized the standalone HM module needs individual secret declarations. I created `modules/sops.nix` (shown above) which provides *both* the top-level `secrets` block (for NixOS) and the individual `sops.secrets."key" = {};` declarations (for standalone HM). This module is then imported by both builders. **Result:** Still the same error.

### The Core Question

I feel like I'm running in circles. The configuration seems to align with examples I've found, yet it fails. Why is the `config.sops.secrets` attribute set not being populated during the `homeConfigurations` build, even when the `sops-nix` module is imported and configured?

Is there a fundamental conflict between `flake-parts`, the library (`lib`) pattern, and how the standalone `sops-nix` Home Manager module discovers its configuration?

Any help or insight would be incredibly appreciated. Thank you!

**Link to my repository for full context:** [PASTE GITHUB REPO LINK HERE]

---
### **Update & A New Clue**

After refactoring my `lib/default.nix` to accept `specialArgs` and `extraSpecialArgs` and injecting a centralized `sopsConfig` from `flake.nix`, the error has moved.

The standalone `homeConfigurations` build now proceeds, but the **`nixosConfigurations`** build fails with a very similar error:

```
error: attribute '"ssh_keys/github"' missing
   at /.../nix/hosts/lf-nix/config.nix:200:31:
      199|       enable = true;
      200|       authorizedKeysFiles = [ config.sops.secrets."ssh_keys/github".path ];
         |                               ^
      201|     };
```

This is happening inside a NixOS module, where I'm trying to set up an authorized SSH key for a user.

This is a significant clue. It tells me:
1.  The problem is not exclusive to the standalone Home Manager setup.
2.  The issue is fundamental to how the `sops` configuration is being passed to and evaluated by the `sops-nix` module in *both* contexts.
3.  Injecting the configuration via `specialArgs` was a good structural change, but it didn't solve the underlying evaluation problem.

My `flake.nix` now looks like this:
```nix
# flake.nix (snippet)
flake =
  let
    lib = import ./lib { inherit inputs; };
    hosts = import ./lib/hosts.nix { inherit inputs; };

    # Centralized sops configuration
    sopsConfig = {
      sops = {
        defaultSopsFile = ./secrets/secrets.yaml;
        # ... and the rest of the sops config
      };
    };
  in
  {
    nixosConfigurations = lib.mapAttrs'
      (name: config: lib.nameValuePair name (lib.buildNixosSystem (config // {
        host = name;
        specialArgs = (config.specialArgs or {}) // { inherit sopsConfig; };
      })))
      hosts.nixos;
    # ... homeConfigurations is similar
  };
```

And my `lib/default.nix` now accepts `specialArgs`:
```nix
# lib/default.nix (snippet)
buildNixosSystem = { ..., specialArgs ? {} }:
  lib.nixosSystem {
    specialArgs = specialArgs // {
      # ... my default specialArgs
    };
    modules = [
      # ... my modules
      inputs.sops-nix.nixosModules.sops # sops-nix module is here
    ];
  };
```

### Revised Core Question

Why is the `sopsConfig` attribute set, when passed into the `modules` list of `nixosSystem` (or `homeManagerConfiguration`), not being correctly evaluated by the `sops-nix` module, resulting in an empty `config.sops.secrets` set? Is there a specific way that a module *containing* configuration needs to be structured or imported when using a `flake-parts` and library-based setup?
````